name: kohya_image_unified
channels:
  - conda-forge
  - defaults

dependencies:
  - python=3.10.19
  - pip=25.3
  - git
  - ffmpeg

  - pip:
      # Keep ONE CUDA line for the whole environment to avoid torch/vision/audio mismatches.
      - '--index-url https://pypi.org/simple'
      - '--extra-index-url https://download.pytorch.org/whl/cu128'

      # === Core GPU stack (aligned with your Kohya env) ===
      - torch==2.9.1+cu128
      - torchvision==0.24.1+cu128
      - torchaudio==2.9.1+cu128
      - xformers==0.0.33.post2

      # === Kohya deps ===
      - accelerate>=1.7.0
      - aiofiles==23.2.1
      - altair==4.2.2
      - dadaptation==3.2
      - 'diffusers[torch]==0.32.2'
      - easygui==0.98.3
      - einops==0.7.0
      - fairscale==0.4.13
      - ftfy==6.1.1
      - gradio>=5.34.1
      - huggingface-hub==0.29.3
      - imagesize==1.4.1
      - invisible-watermark==0.2.0
      - lion-pytorch==0.0.6
      - lycoris_lora==3.2.0.post2
      - omegaconf==2.3.0
      - onnx==1.16.1
      - onnxruntime-gpu==1.19.2
      - open-clip-torch==2.20.0
      # NOTE: opencv-python and opencv-contrib-python conflict with each other.
      # Use contrib only (it includes cv2 + extra modules).
      - opencv-contrib-python==4.10.0.84
      - prodigyopt==1.1.2
      - prodigy-plus-schedule-free==1.8.0
      - protobuf==3.20.3
      - pytorch-lightning==1.9.0
      - pytorch-optimizer==3.5.0
      - rich>=13.7.1
      - safetensors==0.4.4
      - schedulefree==1.4
      - scipy==1.11.4
      - sentencepiece==0.2.0
      - timm==1.0.15
      - tk==0.1.0
      - toml==0.10.2
      - transformers==4.44.2
      - voluptuous==0.13.1
      - wandb==0.18.0
      - bitsandbytes>=0.45.0
      - tensorboard==2.15.2
      - tensorflow==2.15.0.post1

      # === Shared / general utilities ===
      - numpy==1.26.4
      - pillow
      - pyyaml
      - tqdm
      - datasets
      - imageio
      - scikit-image
      - requests

      # === Image processing / SAM2 pipeline deps (from your list + your scripts) ===
      - ultralytics==8.3.115
      - ImageHash
      - hf_xet
      - supervision
      - sam2==1.1.0

      # GroundingDINO (you referenced these wheels). Keep markers for win/linux.
      - groundingdino @ https://huggingface.co/MonsterMMORPG/Wan_GGUF/resolve/main/groundingdino-0.1.0-cp310-cp310-linux_x86_64.whl ; sys_platform == 'linux'
      - groundingdino @ https://huggingface.co/MonsterMMORPG/Wan_GGUF/resolve/main/groundingdino-0.1.0-cp310-cp310-win_amd64.whl ; sys_platform == 'win32'

      # OPTIONAL: These sometimes cause crashes / version pin fights (install only if you truly need them).
      # - sageattention @ https://huggingface.co/MonsterMMORPG/Wan_GGUF/resolve/main/sageattention-2.2.0-cp39-abi3-linux_x86_64.whl ; sys_platform == 'linux'
      # - sageattention @ https://huggingface.co/MonsterMMORPG/Wan_GGUF/resolve/main/sageattention-2.2.0-cp39-abi3-win_amd64.whl ; sys_platform == 'win32'
      # - triton-windows<3.5 ; sys_platform == 'win32'
